# create_gametracker_zip.ps1
# Ejecutar: Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass -Force
#          .\create_gametracker_zip.ps1

$Base = Join-Path $env:USERPROFILE "Desktop\GameTrackerFiles"
Write-Host "Creating project files in $Base ..."
Remove-Item -Recurse -Force $Base -ErrorAction SilentlyContinue
New-Item -ItemType Directory -Path $Base | Out-Null

# Backend directories
$backend = Join-Path $Base "final_backend"
New-Item -ItemType Directory -Path $backend | Out-Null
New-Item -ItemType Directory -Path (Join-Path $backend "models") | Out-Null
New-Item -ItemType Directory -Path (Join-Path $backend "controllers") | Out-Null
New-Item -ItemType Directory -Path (Join-Path $backend "routes") | Out-Null

# Frontend directories
$frontend = Join-Path $Base "final_frontend"
New-Item -ItemType Directory -Path $frontend | Out-Null
New-Item -ItemType Directory -Path (Join-Path $frontend "src") | Out-Null
New-Item -ItemType Directory -Path (Join-Path $frontend "src\components") | Out-Null

# ------------------------------
# Write backend files
# ------------------------------
# server.js
@"
const express = require('express');
const mongoose = require('mongoose');
const cors = require('cors');
require('dotenv').config();

const gameRoutes = require('./routes/gameRoutes');
const reviewRoutes = require('./routes/reviewRoutes');

const app = express();
app.use(cors());
app.use(express.json());

const PORT = process.env.PORT || 5001;
const MONGO_URI = process.env.MONGO_URI || 'mongodb://127.0.0.1:27017/gametracker';

app.use('/api/games', gameRoutes);
app.use('/api/reviews', reviewRoutes);

app.get('/', (req, res) => res.json({ status: 'ok', message: 'GameTracker backend running' }));

mongoose.connect(MONGO_URI, { useNewUrlParser: true, useUnifiedTopology: true })
  .then(() => {
    console.log('‚úÖ Connected to MongoDB');
    app.listen(PORT, () => console.log(`üöÄ Server running on http://localhost:${PORT}`));
  })
  .catch(err => {
    console.error('‚ùå MongoDB connection error:', err.message);
    process.exit(1);
  });
"@ > (Join-Path $backend "server.js")

# package.json
@"
{
  "name":"gametracker-backend",
  "version":"1.0.0",
  "main":"server.js",
  "scripts":{"start":"node server.js","dev":"nodemon server.js"},
  "dependencies":{"express":"^4.18.2","mongoose":"^7.6.0","cors":"^2.8.5","dotenv":"^16.3.1"},
  "devDependencies":{"nodemon":"^2.0.22"}
}
"@ > (Join-Path $backend "package.json")

# .env.example
"MONGO_URI=your_mongodb_uri_here`nPORT=5001" > (Join-Path $backend ".env.example")

# models/Game.js
@"
const mongoose = require('mongoose');

const gameSchema = new mongoose.Schema({
  title: { type: String, required: true },
  platform: { type: String },
  coverUrl: { type: String },
  description: { type: String },
  hoursPlayed: { type: Number, default: 0 },
  completed: { type: Boolean, default: false },
  score: { type: Number, min:0, max:10 }
}, { timestamps: true });

module.exports = mongoose.model('Game', gameSchema);
"@ > (Join-Path $backend "models\Game.js")

# models/Review.js
@"
const mongoose = require('mongoose');

const reviewSchema = new mongoose.Schema({
  gameId: { type: mongoose.Schema.Types.ObjectId, ref: 'Game', required: true },
  author: { type: String, default: 'Anonymous' },
  text: { type: String, required: true },
  score: { type: Number, min: 0, max: 10, required: true }
}, { timestamps: true });

module.exports = mongoose.model('Review', reviewSchema);
"@ > (Join-Path $backend "models\Review.js")

# controllers/gameController.js
@"
const Game = require('../models/Game');

const getGames = async (req,res) => {
  try {
    const games = await Game.find().sort({createdAt:-1});
    res.status(200).json(games);
  } catch (err) {
    res.status(500).json({ message: err.message });
  }
};

const getGameById = async (req,res) => {
  try {
    const game = await Game.findById(req.params.id);
    if (!game) return res.status(404).json({ message: 'Game not found' });
    res.json(game);
  } catch (err) {
    res.status(500).json({ message: err.message });
  }
};

const createGame = async (req,res) => {
  try {
    const { title, platform, coverUrl, description, hoursPlayed, completed, score } = req.body;
    const newGame = await Game.create({ title, platform, coverUrl, description, hoursPlayed, completed, score });
    res.status(201).json(newGame);
  } catch (err) {
    res.status(400).json({ message: err.message });
  }
};

const updateGame = async (req,res) => {
  try {
    const updated = await Game.findByIdAndUpdate(req.params.id, req.body, { new: true });
    if (!updated) return res.status(404).json({ message: 'Game not found' });
    res.json(updated);
  } catch (err) {
    res.status(400).json({ message: err.message });
  }
};

const deleteGame = async (req,res) => {
  try {
    const removed = await Game.findByIdAndDelete(req.params.id);
    if (!removed) return res.status(404).json({ message: 'Game not found' });
    res.json({ message: 'Game deleted' });
  } catch (err) {
    res.status(500).json({ message: err.message });
  }
};

module.exports = { getGames, getGameById, createGame, updateGame, deleteGame };
"@ > (Join-Path $backend "controllers\gameController.js")

# controllers/reviewController.js
@"
const Review = require('../models/Review');
const Game = require('../models/Game');

const getReviews = async (req,res) => {
  try {
    const { gameId } = req.params;
    if (gameId) {
      const reviews = await Review.find({ gameId }).sort({createdAt:-1});
      return res.json(reviews);
    }
    const reviews = await Review.find().sort({createdAt:-1});
    res.json(reviews);
  } catch (err) {
    res.status(500).json({ message: err.message });
  }
};

const getReviewById = async (req,res) => {
  try {
    const review = await Review.findById(req.params.id);
    if (!review) return res.status(404).json({ message: 'Review not found' });
    res.json(review);
  } catch (err) {
    res.status(500).json({ message: err.message });
  }
};

const createReview = async (req,res) => {
  try {
    const { gameId } = req.params;
    const { author, text, score } = req.body;
    const game = await Game.findById(gameId);
    if (!game) return res.status(400).json({ message: 'Invalid gameId' });
    const newReview = await Review.create({ gameId, author, text, score });
    res.status(201).json(newReview);
  } catch (err) {
    res.status(400).json({ message: err.message });
  }
};

const updateReview = async (req,res) => {
  try {
    const updated = await Review.findByIdAndUpdate(req.params.id, req.body, { new: true });
    if (!updated) return res.status(404).json({ message: 'Review not found' });
    res.json(updated);
  } catch (err) {
    res.status(400).json({ message: err.message });
  }
};

const deleteReview = async (req,res) => {
  try {
    const removed = await Review.findByIdAndDelete(req.params.id);
    if (!removed) return res.status(404).json({ message: 'Review not found' });
    res.json({ message: 'Review deleted' });
  } catch (err) {
    res.status(500).json({ message: err.message });
  }
};

module.exports = { getReviews, getReviewById, createReview, updateReview, deleteReview };
"@ > (Join-Path $backend "controllers\reviewController.js")

# routes/gameRoutes.js
@"
const express = require('express');
const router = express.Router();
const { getGames, getGameById, createGame, updateGame, deleteGame } = require('../controllers/gameController');

router.get('/', getGames);
router.post('/', createGame);
router.get('/:id', getGameById);
router.put('/:id', updateGame);
router.delete('/:id', deleteGame);

module.exports = router;
"@ > (Join-Path $backend "routes\gameRoutes.js")

# routes/reviewRoutes.js
@"
const express = require('express');
const router = express.Router();
const { getReviews, getReviewById, createReview, updateReview, deleteReview } = require('../controllers/reviewController');

// /api/reviews/               -> all reviews
// /api/reviews/game/:gameId   -> reviews for a game
router.get('/', getReviews);
router.get('/game/:gameId', getReviews);
router.get('/:id', getReviewById);
router.post('/game/:gameId', createReview);
router.put('/:id', updateReview);
router.delete('/:id', deleteReview);

module.exports = router;
"@ > (Join-Path $backend "routes\reviewRoutes.js")

# README backend
@"
# GameTracker Backend

API REST para GameTracker. Copia .env.example a .env y completa MONGO_URI.
"@ > (Join-Path $backend "README.md")

# ------------------------------
# Write frontend files (CRA-like)
# ------------------------------
# src/index.js
@"
import React from 'react';
import ReactDOM from 'react-dom/client';
import './styles.css';
import App from './App';

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);
"@ > (Join-Path $frontend "src\index.js")

# src/App.js
@"
import React, { useEffect, useState } from 'react';
import GameList from './components/GameList';
import GameForm from './components/GameForm';
import Stats from './components/Stats';
import './styles.css';

const API = process.env.REACT_APP_API || 'http://localhost:5001/api';

export default function App(){
  const [games, setGames] = useState([]);
  const [loading, setLoading] = useState(true);

  const fetchGames = async () => {
    try {
      setLoading(true);
      const res = await fetch(`${API}/games`);
      const data = await res.json();
      setGames(data);
    } catch (err) {
      console.error(err);
    } finally {
      setLoading(false);
    }
  };

  useEffect(()=> { fetchGames(); }, []);

  return (
    <div className='app-root'>
      <nav className='topbar'>
        <div className='brand'>GameTracker</div>
        <div className='nav-actions'>Mi Biblioteca</div>
      </nav>

      <main className='container'>
        <div className='left'>
          <GameForm onCreated={fetchGames} />
          <Stats games={games} />
        </div>
        <section className='right'>
          {loading ? <div className='loader'>Cargando...</div> : <GameList games={games} onUpdate={fetchGames} />}
        </section>
      </main>

      <footer className='footer'>Proyecto GameTracker ¬∑ Diego189d</footer>
    </div>
  );
}
"@ > (Join-Path $frontend "src\App.js")

# styles.css
@"
:root{ --bg-primary:#121212; --bg-secondary:#1E1E1E; --bg-tertiary:#2A2A2A; --text-high:#FFFFFF; --text-medium:#AAAAAA; --brand:#E05D5D; --star:#FFD700; --radius-md:8px }
*{box-sizing:border-box} body{margin:0;background:var(--bg-primary);color:var(--text-high);font-family:Inter, Arial, sans-serif}
.topbar{position:sticky;top:0;display:flex;align-items:center;justify-content:space-between;height:64px;background:var(--bg-primary);padding:0 20px;border-bottom:1px solid rgba(255,255,255,0.03)}
.brand{font-weight:800;color:var(--brand)} .container{display:flex;gap:20px;padding:24px;max-width:1200px;margin:20px auto} .left{width:320px} .right{flex:1} .footer{text-align:center;padding:16px;color:var(--text-medium)}
.card{background:var(--bg-secondary);border-radius:var(--radius-md);padding:16px;border:1px solid rgba(255,255,255,0.03)}
.game-form input, .game-form textarea{width:100%;padding:10px;margin-bottom:10px;border-radius:6px;background:var(--bg-tertiary);border:1px solid rgba(255,255,255,0.04);color:var(--text-high)}
.game-form button{width:100%;padding:10px;background:var(--brand);color:var(--text-high);border:none;border-radius:6px;font-weight:700;cursor:pointer}
.game-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px}
.game-card{display:flex;gap:12px;align-items:flex-start}
.thumb{width:110px;height:150px;background:#222;border-radius:6px;overflow:hidden;display:flex;align-items:center;justify-content:center}
.placeholder{width:110px;height:150px;display:flex;align-items:center;justify-content:center;color:var(--text-medium);background:#262626;border-radius:6px}
.actions button{margin-right:8px;padding:6px 8px;border-radius:6px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--text-high);cursor:pointer}
.stats{margin-top:16px}.stat-item{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px dashed rgba(255,255,255,0.02);color:var(--text-medium)}
"@ > (Join-Path $frontend "src\styles.css")

# components
# GameForm
@"
import React, { useState } from 'react';
const API = process.env.REACT_APP_API || 'http://localhost:5001/api';

export default function GameForm({ onCreated }) {
  const [form, setForm] = useState({ title:'', platform:'', coverUrl:'', description:'', hoursPlayed:0, completed:false, score:0});
  const [saving, setSaving] = useState(false);
  const [error, setError] = useState('');

  const handleChange = (e) => {
    const { name, value, type, checked } = e.target;
    setForm(prev => ({ ...prev, [name]: type==='checkbox'?checked : (name==='hoursPlayed' || name==='score'? Number(value): value) }));
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!form.title) { setError('El t√≠tulo es obligatorio'); return; }
    setSaving(true); setError('');
    try {
      const res = await fetch(`${API}/games`, {
        method: 'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify(form)
      });
      if (res.ok) {
        setForm({ title:'', platform:'', coverUrl:'', description:'', hoursPlayed:0, completed:false, score:0});
        onCreated();
      } else {
        const txt = await res.text();
        setError('Error al crear: '+txt);
      }
    } catch (err) {
      setError('Error de red: ' + err.message);
    } finally { setSaving(false); }
  };

  return (
    <div className='card game-form'>
      <h3>Agregar juego</h3>
      {error && <div style={{color:'#ffb3b3',marginBottom:8}}>{error}</div>}
      <form onSubmit={handleSubmit}>
        <label>T√≠tulo *</label>
        <input name='title' value={form.title} onChange={handleChange} placeholder='T√≠tulo' required />
        <label>Plataforma</label>
        <input name='platform' value={form.platform} onChange={handleChange} placeholder='Plataforma' />
        <label>URL Portada</label>
        <input name='coverUrl' value={form.coverUrl} onChange={handleChange} placeholder='https://...' />
        <label>Descripci√≥n</label>
        <textarea name='description' value={form.description} onChange={handleChange} placeholder='Descripci√≥n' />
        <label>Horas jugadas</label>
        <input name='hoursPlayed' type='number' value={form.hoursPlayed} onChange={handleChange} />
        <label>Puntuaci√≥n (0-10)</label>
        <input name='score' type='number' value={form.score} onChange={handleChange} min='0' max='10' />
        <label><input name='completed' type='checkbox' checked={form.completed} onChange={handleChange} /> Completado</label>
        <button type='submit' disabled={saving}>{saving? 'Guardando...' : 'Agregar juego'}</button>
      </form>
    </div>
  );
}
"@ > (Join-Path $frontend "src\components\GameForm.js")

# GameList
@"
import React from 'react';
import GameCard from './GameCard';

export default function GameList({ games, onUpdate }) {
  return (
    <div className='game-list'>
      {games.length === 0 ? <div className='card'>No hay juegos a√∫n.</div> : games.map(g => <GameCard key={g._id} game={g} onUpdate={onUpdate} />)}
    </div>
  );
}
"@ > (Join-Path $frontend "src\components\GameList.js")

# GameCard
@"
import React from 'react';
import ReviewList from './ReviewList';
import ReviewForm from './ReviewForm';
const API = process.env.REACT_APP_API || 'http://localhost:5001/api';

export default function GameCard({ game, onUpdate }) {
  const handleDelete = async () => {
    if (!confirm('Eliminar este juego?')) return;
    try {
      const res = await fetch(`${API}/games/${game._id}`, { method: 'DELETE' });
      if (res.ok) onUpdate();
    } catch (err) { console.error(err); }
  };

  const toggleCompleted = async () => {
    try {
      await fetch(`${API}/games/${game._id}`, {
        method: 'PUT',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ completed: !game.completed })
      });
      onUpdate();
    } catch (err){ console.error(err); }
  };

  return (
    <div className='card game-card'>
      <div className='thumb'>
        {game.coverUrl ? <img src={game.coverUrl} alt={game.title} /> : <div className='placeholder'>No Cover</div>}
      </div>
      <div className='info'>
        <h3>{game.title}</h3>
        <div className='meta'>{game.platform} ‚Ä¢ {new Date(game.createdAt).toLocaleDateString()}</div>
        <div>{game.description}</div>
        <div className='meta'>Horas: {game.hoursPlayed} ‚Ä¢ Puntuaci√≥n: {game.score ?? '-'}</div>
        <div className='actions'>
          <button onClick={toggleCompleted}>{game.completed? 'Marcar no completado' : 'Marcar completado'}</button>
          <button onClick={handleDelete}>Eliminar</button>
        </div>

        <ReviewList gameId={game._id} />
        <ReviewForm gameId={game._id} onSaved={onUpdate} />
      </div>
    </div>
  );
}
"@ > (Join-Path $frontend "src\components\GameCard.js")

# Stats
@"
import React from 'react';

export default function Stats({ games }) {
  const total = games.length;
  const completed = games.filter(g=>g.completed).length;
  const hours = games.reduce((s,g)=>s + (g.hoursPlayed||0), 0);
  const avgScore = total ? (games.reduce((s,g)=>s + (g.score||0), 0)/total).toFixed(2) : 0;

  return (
    <div className='card stats'>
      <h3>Estad√≠sticas</h3>
      <div className='stat-item'><strong>Total</strong><span>{total}</span></div>
      <div className='stat-item'><strong>Completados</strong><span>{completed}</span></div>
      <div className='stat-item'><strong>Horas</strong><span>{hours}</span></div>
      <div className='stat-item'><strong>Punt. Promedio</strong><span>{avgScore}</span></div>
    </div>
  );
}
"@ > (Join-Path $frontend "src\components\Stats.js")

# ReviewList
@"
import React, { useEffect, useState } from 'react';
import ReviewCard from './ReviewCard';
const API = process.env.REACT_APP_API || 'http://localhost:5001/api';

export default function ReviewList({ gameId }) {
  const [reviews, setReviews] = useState([]);

  const load = async () => {
    try {
      const res = await fetch(`${API}/reviews/game/${gameId}`);
      const data = await res.json();
      setReviews(data);
    } catch (err) { console.error(err); }
  };

  useEffect(()=>{ load(); }, [gameId]);

  return (
    <div className='card' style={{marginTop:10}}>
      <h4>Rese√±as</h4>
      {reviews.length === 0 ? <p style={{color:'#AAA'}}>No hay rese√±as todav√≠a.</p> : reviews.map(r => <ReviewCard key={r._id} review={r} />)}
    </div>
  );
}
"@ > (Join-Path $frontend "src\components\ReviewList.js")

# ReviewForm
@"
import React, { useState } from 'react';
const API = process.env.REACT_APP_API || 'http://localhost:5001/api';

export default function ReviewForm({ gameId, onSaved }) {
  const [text, setText] = useState('');
  const [score, setScore] = useState(0);
  const [saving, setSaving] = useState(false);

  const submit = async (e) => {
    e.preventDefault();
    setSaving(true);
    try {
      const res = await fetch(`${API}/reviews/game/${gameId}`, {
        method: 'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ author: 'Anon', text, score })
      });
      if (res.ok) {
        setText(''); setScore(0);
        onSaved();
      }
    } catch(err){ console.error(err); }
    setSaving(false);
  };

  return (
    <div className='card' style={{ marginTop:10 }}>
      <h4>Agregar rese√±a</h4>
      <form onSubmit={submit}>
        <textarea value={text} onChange={(e)=>setText(e.target.value)} placeholder='Escribe tu rese√±a...' style={{width:'100%',padding:10,borderRadius:6,background:'#2A2A2A',color:'white',border:'1px solid #444'}} />
        <label>Puntuaci√≥n (0-10)</label>
        <input type='number' min='0' max='10' value={score} onChange={(e)=>setScore(Number(e.target.value))} style={{width:'100%',padding:10,borderRadius:6,background:'#2A2A2A',color:'white',border:'1px solid #444'}} />
        <button type='submit' disabled={saving} style={{marginTop:10}}>{saving? 'Guardando...' : 'Guardar rese√±a'}</button>
      </form>
    </div>
  );
}
"@ > (Join-Path $frontend "src\components\ReviewForm.js")

# ReviewCard
@"
import React from 'react';

export default function ReviewCard({ review }) {
  return (
    <div style={{borderBottom:'1px solid rgba(255,255,255,0.07)',padding:'10px 0'}}>
      <div style={{fontSize:14,color:'#FFD700'}}>‚òÖ {review.score}/10</div>
      <div style={{marginTop:4}}>{review.text}</div>
      <div style={{marginTop:4,color:'#AAA',fontSize:12}}>{new Date(review.createdAt).toLocaleDateString()}</div>
    </div>
  );
}
"@ > (Join-Path $frontend "src\components\ReviewCard.js")

# frontend package.json
@"
{
  "name":"gametracker-frontend",
  "version":"1.0.0",
  "private": true,
  "dependencies": {
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "react-scripts": "5.0.1"
  },
  "scripts":{
    "start":"react-scripts start",
    "build":"react-scripts build",
    "test":"react-scripts test",
    "eject":"react-scripts eject"
  }
}
"@ > (Join-Path $frontend "package.json")

# frontend README
@"
# GameTracker Frontend

React app. Reemplaza src en CRA o ejecuta npm install y npm start.
"@ > (Join-Path $frontend "README.md")

# ------------------------------
# Create zips
# ------------------------------
$backendZip = Join-Path $Base "final_backend.zip"
$frontendZip = Join-Path $Base "final_frontend.zip"
$finalZip = Join-Path $Base "GameTracker_Final_Full.zip"

if (Test-Path $backendZip) { Remove-Item $backendZip -Force }
if (Test-Path $frontendZip) { Remove-Item $frontendZip -Force }
if (Test-Path $finalZip) { Remove-Item $finalZip -Force }

Add-Type -AssemblyName System.IO.Compression.FileSystem
[System.IO.Compression.ZipFile]::CreateFromDirectory($backend, $backendZip)
[System.IO.Compression.ZipFile]::CreateFromDirectory($frontend, $frontendZip)

# Combine into final zip and include proyecto.pdf if present at /mnt/data/proyecto.pdf
$final = [IO.Compression.ZipFile]::Open($finalZip, [IO.Compression.ZipArchiveMode]::Create)
$final.CreateEntryFromFile($backendZip, "backend.zip") | Out-Null
$final.CreateEntryFromFile($frontendZip, "frontend.zip") | Out-Null

$projPdf = "/mnt/data/proyecto.pdf"
if (Test-Path $projPdf) {
  try {
    $final.CreateEntryFromFile($projPdf, (Split-Path $projPdf -Leaf)) | Out-Null
  } catch { Write-Host "Could not include proyecto.pdf: $_" }
}

$final.Dispose()

Write-Host "Zips creados en: $Base"
Write-Host "ZIP final: $finalZip"
Write-Host "Backend ZIP: $backendZip"
Write-Host "Frontend ZIP: $frontendZip"
